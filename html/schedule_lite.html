<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">

<dom-module id="schedule-lite">
  <style>
    /* TODO(polyup): For speed, consider reworking these styles with .classes
                     and #ids rather than [attributes].
    */
    [layout] {
      @apply(--layout);
    }
    [layout][vertical] {
      @apply(--layout-vertical);
    }
    [layout][center] {
      @apply(--layout-center);
    }
  </style>
  <style>
    :host {
      xwidth: 100%;
      display: block;
      position: relative;
      background-color: #efefef;
      margin-bottom: 1px;
      transition: 150ms cubic-bezier(0.4, 0.0, 0.2, 1);
    }
    :host-context(.no-transition) {
      transition: none;
    }
    .date {
      padding: 16px;
      font-size: 14px;
      color: gray;
    }
    .card {
      margin-bottom: 1px;
      background: white;
    }
    p {
      margin: 0px;
    }
    .check {
      width: 70px;
      margin-left: 16px;
      margin-right: 32px;
      font-weight: bold;
      color: #2196f3;
    }
    .check:after {
      content: "SHARED";
    }
    .clear {
      width: 70px;
      margin-left: 16px;
      margin-right: 32px;
      #font-weight: bold;
      color: lightgray;
    }
    .clear:after {
      content: "------------";
    }
    .hidden {
      opacity: 0.5;
    }
    .time {
      margin-top: 10px;
      margin-bottom: 2px;
      font-size: 14px;
      font-weight: 300;
      color: gray;
    }
    .name {
      margin-top: 2px;
      margin-bottom: 10px;
      font-size: 16px;
    }
  </style>
  <template>
    <paper-material elevation="2" on-track="handleTrack">
      <div class="date">{{dateString}}</div>
      <template is="dom-repeat" id="entryList" items="{{entries}}">
        <div class$="{{computeHidden(item)}}" layout="" horizontal="" center>
          <div class$="{{computeShared(item)}}"></div>
          <div layout vertical>
            <p class="time">
              <span>{{item.startTime}}</span> - <span>{{item.endTime}}</span>
                <template is="dom-if" if="{{hasTeacherAndRoom(item)}}">
                  (<span>{{item.teacherLastName}}</span>,
                  <span>{{item.room}}</span>)
                </template>
                <template is="dom-if" if="{{hasTeacherOnly(item)}}">
                  (<span>{{item.teacherLastName}}</span>)
                </template>
                <template is="dom-if" if="{{hasRoomOnly(item)}}">
                  (<span>{{item.room}}</span>)
                </template>
            </p>
            <p class="name"><span>{{item.name}}</span></p>
          </div>
        </div>
      </template>
    </paper-material>
  </template>
  <script>
    Polymer({
      is: 'schedule-lite',
      properties: {
        entries: { notify: true },
        dateString: String
      },
      listeners: {
        "transitionend": "transitionEnd"
      },

      handleTrack: function(e) {
        switch (e.detail.state) {
          case 'start':
            this.enableTransition(false);
            this.axis = (Math.abs(e.detail.dx) >
                         Math.abs(e.detail.dy)) ? 'x' : 'y';
            break;
          case 'track':
            if (this.axis == 'x') {
              this.translateX(e.detail.dx);
            }
            break;
          case 'end':
            this.axis = undefined;
            this.enableTransition(true);
            this.maybeSwipe(e.detail.dx);
            break;
        }
      },
      enableTransition: function(enable) {
        if (enable) {
          this.classList.remove('no-transition');
        } else {
          this.classList.add('no-transition');
        }
      },
      translateX: function(x) {
        var s = this.style;
        var translate = 'translate3d(' + x + 'px,0,0)';
        s.transform = s.webkitTransform = translate;
      },
      maybeSwipe: function(dx) {
        // If we've moved more than 1/4 of our width, swipe away
        this.swiped = Math.abs(dx) > this.offsetWidth / 4;
        if (this.swiped) {
          this.dest = (window.innerWidth + this.offsetWidth + 1) / 2 *
                      (dx / Math.abs(dx));
          this.translateX(this.dest);
        } else {
          this.translateX(0);
        }
      },
      transitionEnd: function(e) {
        // When we swipe offscreen, fire an event, silently switch to the
        // other side of the screen, and then transition back to the center.
        if (this.swiped) {
          var dir = (this.dest < 0) ? 'left' : 'right';
          this.fire('swiped', {direction: dir});
          this.swiped = false;
          this.enableTransition(false);
          this.translateX(-this.dest);
          this.dest = null;

          var that = this;
          setTimeout(function() {
            that.enableTransition(true);
            that.translateX(0);
          }, 0);
        }
      },


      computeShared: function(item) {
        if (item.shared) {
          return "check";
        } else {
          return "clear";
        }
      },
      computeHidden: function(item) {
        var classes = "card";

        if (item.name == "Hidden") {
          classes += " hidden";
        }
        return classes;
      },


      hasTeacherAndRoom: function(item) {
        return item.teacherLastName && item.room;
      },
      hasTeacherOnly: function(item) {
        return item.teacherLastName && !item.room;
      },
      hasRoomOnly: function(item) {
        return !item.teacherLastName && item.room;
      },
    });
  </script>
</dom-module>
