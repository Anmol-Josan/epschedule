<!DOCTYPE html><html><head>

  <title>EPSchedule</title>
  <meta charset="utf=8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <script src="bower_components/webcomponentsjs/webcomponents-lite.js"></script>
  <link rel="import" href="bower_components/polymer/polymer.html">
  <link rel="import" href="bower_components/font-roboto/roboto.html">
  <link rel="import" href="bower_components/paper-toolbar/paper-toolbar.html">
  <link rel="import" href="bower_components/paper-drawer-panel/paper-drawer-panel.html">
  <link rel="import" href="bower_components/paper-header-panel/paper-header-panel.html">
  <link rel="import" href="bower_components/iron-icons/iron-icons.html">
  <link rel="import" href="bower_components/paper-button/paper-button.html">
  <link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
  <link rel="import" href="bower_components/paper-dialog/paper-dialog.html">
  <link rel="import" href="bower_components/paper-input/paper-input.html">
  <link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout.html">`
  <link rel="import" href="bower_components/google-map/google-map.html">
  <link rel="import" href="bower_components/google-map/google-map-search.html">
  <link rel="import" href="bower_components/google-map/google-map-marker.html">
  <link rel="import" href="bower_components/google-map/google-map-directions.html">
  <link rel="import" href="bower_components/paper-toast/paper-toast.html">
  <link rel="import" href="bower_components/iron-icons/communication-icons.html">
  <link rel="import" href="bower_components/neon-animation/neon-animated-pages.html">
  <link rel="import" href="bower_components/neon-animation/neon-animations.html">
  <link rel="import" href="bower_components/neon-animation/demo/dropdown/animated-dropdown.html">
  <link rel="import" href="bower_components/iron-image/iron-image.html">
  <link rel="import" href="item.html">
  <script>
  var touchStartPos = [0, 0];
  function handleTouchStart(evt) {
    touchStartPos[0] = evt.changedTouches[0].pageX;
    touchStartPos[1] = evt.changedTouches[0].pageY;
  }
  function handleTouchEnd(evt) {
    if (Math.abs(touchStartPos[0] - evt.changedTouches[0].pageX) > Math.abs(touchStartPos[1] - evt.changedTouches[0].pageY)) { //If the swipe is horizontal
        if (touchStartPos[0] > evt.changedTouches[0].pageX) {
            dateForward();
        } else if (touchStartPos[0] < evt.changedTouches[0].pageX) {
            dateBack();
        }
    }
  }

  function signOut() {
    xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
      if (xhr.readyState == 4) {
        if (xhr.status==200) {
          location.reload();
        } else {
          result = JSON.parse(xhr.responseText);
          console.log(result.error);
        }
      }
    }
    xhr.open("POST", "logout", true);
    xhr.send();
  }
  function reportBug() {
    window.open("https://github.com/guberti/epschedule/issues");
  }
  function about() {
    window.open("about");
  }
  function openDialog() {
      var dialog = document.getElementById("dialog");
      if (dialog) {
        dialog.open();
      }
  }
  function openSettings() {
    paperDialog = document.getElementById("dialog");
    paperDialog.style.width = "425px";
    paperDialog.innerHTML = '<div id="settingspanel"><h2>Settings</h2><h3>Change password</h3>' +
    '<paper-input label="Old password" id="oldpassword" type="password"></paper-input>' +
    '<paper-input label="New password" id="newpassword" type="password"></paper-input>' +
    '<paper-button onclick="submitChangePassword()" raised id="changepassword">CHANGE PASSWORD</paper-button></div>';
    openDialog();
  }
  function submitChangePassword() {
    var data = new FormData();
    var email = schedule['firstname'][0] + schedule['lastname'];
    email = email + "@eastsideprep.org";
    email = email.toLowerCase();
    var oldPassword = document.getElementById("oldpassword")
    var newPassword = document.getElementById("newpassword")
    data.append('email', email)
    data.append('oldpassword', oldPassword.value)
    data.append('newpassword', newPassword.value)
    xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
      if (xhr.readyState == 4 && xhr.status==200) {
        result = JSON.parse(xhr.responseText);
        if (!result.error) {
          renderToast("Password changed successfully.");
          oldPassword.value = "";
          newPassword.value = "";
          console.log("Changed password!");
        } else {
          console.log(result.error);
          renderToast(result.error);
        }
      }
    }
    xhr.open("POST", "changepassword", true);
    xhr.send(data);
  }
  document.onkeydown = function(event) {
    if (event.keyCode == 37) { //Left
        dateBack();
    } else if (event.keyCode == 39) { //Right
        dateForward();
    }
  }
  document.addEventListener("touchstart", handleTouchStart, false);
  document.addEventListener("touchend", handleTouchEnd, false);
  document.addEventListener("touchleave", handleTouchEnd, false);

  var schedule = {{ schedule | safe }};
  var days = {{days | safe }};
  var globalDate = new Date();

  function dateBack() {
    if (globalDate.getDay() == 1) {
        globalDate.setDate(globalDate.getDate()-2);
    }
    globalDate.setDate(globalDate.getDate()-1);
    renderSchedule(globalDate, true);
  }
  function dateForward() {
    if (globalDate.getDay() == 5) {
        globalDate.setDate(globalDate.getDate()+2);
    }
    globalDate.setDate(globalDate.getDate()+1);
    renderSchedule(globalDate, true);
  }
  function renderToast(text) {
    toast = document.getElementById("toast");
    console.log("Displaying toast");
    console.log(toast);
    toast.setAttribute("text", text);
    toast.show();
  }
  function getGpsSuccess(position, roomObj) {
    var radius = 6371000; //Radius of the earth
    var phi1 = position.coords.latitude * (Math.PI / 180);
    var phi2 = roomObj.latitude * (Math.PI / 180);
    var deltaPhi = (roomObj.latitude-position.coords.latitude) * (Math.PI / 180);
    var deltaLambda = (roomObj.longitude-position.coords.longitude) * (Math.PI / 180);
    var a = Math.sin(deltaPhi/2) * Math.sin(deltaPhi/2) + Math.cos(phi1) *
    Math.cos(phi2) *Math.sin(deltaLambda/2) * Math.sin(deltaLambda/2);
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    var d = radius * c;
    if (d > 200) {
      console.log("Too far away from EPS")
      return;
    }
    map = document.getElementById("map");
    marker = document.createElement("google-map-marker");
    marker.latitude = position.coords.latitude;
    marker.longitude = position.coords.longitude;
    marker.draggable = false;
    marker.title = "Your face";
    map.appendChild(marker);
  }
  function getGpsFail(error) {
    switch(error.code) {
        case error.PERMISSION_DENIED:
            console.log("User did not allow access to GPS")
            break;
        case error.POSITION_UNAVAILABLE:
            console.log("EPSchedule was not able to get location information")
            break;
        case error.TIMEOUT:
            console.log("Request to enable GPS timed out")
            break;
        case error.UNKNOWN_ERROR:
            console.log("Geolocation failed, error unknown")
            break;
    }
  }
  function requestAdditionalData(name, type, funct) {
    //Type is the type of data being requested - [class, teacher, student, room, period]
    //Name is the name of the class, teacher, student, etc.
    var url = type + "/" + name;
    console.log("Requesting " + url);
    xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
      if (xhr.readyState == 4 && xhr.status==200) {
        console.log(xhr.responseText);
        result = JSON.parse(xhr.responseText);
        funct(result);
      }
    }
    xhr.open("GET", url, true);
    xhr.send();
  }
  function renderRoom(roomObj) {
    /*renderToast("Please allow EPSchedule to use your current location"); //TODO check to see if browser allows geolocation by default*/
    //Bug here that causes latitude and longitude of google map tag to not exist
    paperDialog = document.getElementById("dialog");
    paperDialog.removeAttribute("style");
    console.log("Latitude = " + roomObj.latitude);
    console.log("Longitude = " + roomObj.longitude);
    paperDialog.innerHTML = '<google-map latitude="47.643455" longitude="-122.198935" id="map" zoom="18" disable-default-ui fit-to-markers>' +
      '<google-map-marker latitude="' + roomObj.latitude + '" longitude="' + roomObj.longitude + '"' +
      'draggable="false" title="' + roomObj.room + '"></google-map-marker></google-map>';
    openDialog();
    /*if (navigator.geolocation) {
        var success = function(gpsObj) {
          getGpsSuccess(gpsObj, roomObj);
        }
        var fail = function() {
          getGpsFail();
        }
        navigator.geolocation.getCurrentPosition(success, fail);
    } else {
        renderToast("Your browser does not support Geolocation");
    }*/
  }
  function renderClass(classObj) {
    console.log(classObj);
  }
  function renderTeacher(teacherObj) {
    paperDialog = document.getElementById("dialog");
    paperDialog.removeAttribute("style");
    paperDialog.style.width = "700px";
    var imgSrc = "teacher_photos_fullsize/" + teacherObj.firstname + "_";
    imgSrc = imgSrc + teacherObj.lastname + ".jpg";
    imgSrc = imgSrc.toLowerCase();
    email = teacherObj.firstname[0] + teacherObj.lastname + "@eastsideprep.org";
    email = email.toLowerCase();
    paperDialog.innerHTML = '<div>' + '<img src="' + imgSrc +
    '" align="right" class="fullsizeimage"></img><h1>' + teacherObj.firstname +
    ' ' + teacherObj.lastname + '</h1><h3><a href="mailto:' + email + '">' +
    email + '</a></h3><p>' + teacherObj.bio + '</p></div>' +
    '<div id="teacherschedulecontainer"></div>';
    paperDialog.open();
  }
  function renderStudent(studentObj) {
    console.log(studentObj);
  }
  function renderPeriod(periodObj) {
    console.log(periodObj);
  }
  function renderSchedule(dateObj, emptyDiv) {
    switch (dateObj.getDay()) { //Spits out the day of the week as a string
        case 6: //Intentionall fallthrough - requesting a Sunday or Saturday schedule should spit out a Monday schedule
          dateObj.setDate(dateObj.getDate() + 1);
        case 0:
          dateObj.setDate(dateObj.getDate() + 1);
        case 1:
            var day = "Monday";
            break;
        case 2:
            var day = "Tuesday";
            break;
        case 3:
            var day = "Wednesday";
            break;
        case 4:
            var day = "Thursday";
            break;
        case 5:
            var day = "Friday";
            break;
    }

    // TODO: replace this gross HTML munging with data binding
    var dateText = (day + ', ' + (dateObj.getMonth() + 1) + "/" + dateObj.getDate());
    var daySpan = document.getElementById("day");
    daySpan.removeChild(daySpan.firstChild);
    daySpan.appendChild(document.createTextNode(dateText));

    todaySchedule = [];
    for (var exception = 0; exception < days[1].length; exception++) { //Handles exceptions, also handles special weekend schedules
        if (days[1][exception]["day"] == dateObj.getDate() && days[1][exception]["month"] == (dateObj.getMonth() + 1) && days[1][exception]["year"] == dateObj.getFullYear()) {
            day = days[1][exception]["schedule"];
        }
    }
    var currentSlot;
    for (currentSlot = 0; currentSlot < days[0][day]["MS"].length; currentSlot++) {
        switch(days[0][day]["MS"][currentSlot]["period"]) { //Falling through is intended in switch statement
            case "0": //0 Period
            case "A": //A period
            case "B": //B period
            case "C": //C period
            case "D": //D period
            case "E": //E period
            case "F": //F period
            case "G": //G period
            case "H": //H period
                for (var k = 0; k < schedule["classes"].length; k++) {
                    if (schedule["classes"][k]["period"] == days[0][day]["MS"][currentSlot]["period"]) {
                        if (schedule["classes"][k]["name"] != "Free Period") {
                            var scheduleObj = { name: schedule["classes"][k]["name"],
                                teacher: schedule["classes"][k]["teacher"],
                                room: schedule["classes"][k]["room"],
                                period: days[0][day]["MS"][currentSlot]["period"],
                                time: "will be determined later"}
                        } else {
                            var scheduleObj = {name: "Free Period",
                                teacher: "N/A",
                                room: "N/A",
                                period: days[0][day]["MS"][currentSlot]["period"],
                                time: "will be determined later"};
                        }
                    }
                }
                break;
            case "Lunch":
                var scheduleObj = { name: "Lunch", teacher: "", room: "LPC Commons", period: 9, time: "will be determined later" };
                break;
            case "Assembly":
                var scheduleObj = { name: "Assembly", teacher: "", room: "LPC Commons", period: 10, time: "will be determined later" };
                break;
            case "Advisory":
                var scheduleObj = { name: "Advisory", teacher: "", room: "", period: 11, time: "will be determined later" }; //TODO - Make this box display the user's advisor and advisory location
                break;
            case "Class Meeting":
                var scheduleObj = { name: "Class Meeting", teacher: "", room: "", period: 12, time: "will be determined later" };
                break;
            case "Clubs":
                var scheduleObj = { name: "Clubs", teacher: "", room: "Varies", period: 13, time: "will be determined later" };
                break;
        }
        if (scheduleObj.teacher == "N/A") {
          scheduleObj.teacher = "";
        }
        if (scheduleObj.room == "N/A") {
          scheduleObj.room = "";
        }
        if (scheduleObj.teacher != "") {
          sanitized_teacher_name = scheduleObj.teacher.toLowerCase();
          sanitized_teacher_name = sanitized_teacher_name.replace(/ /g,"_");
          scheduleObj.avatar = "/96x96_photos/" + sanitized_teacher_name + ".jpg";
          scheduleObj.teacherLink = "/teacher/" + sanitized_teacher_name;
        } else {
          scheduleObj.teacherLink = "";
          scheduleObj.avatar = "/misc_photos/" + scheduleObj.name.toLowerCase().replace(/\s/g, '') + ".jpg";
        }
        scheduleObj.roomLink = "/room/" + scheduleObj.room.toLowerCase().replace(/ /g,"_");

        try {
            var times = days[0][day]["MS"][currentSlot]["time"].split('-');
            scheduleObj.startTime = times[0].trim();
            scheduleObj.endTime = times[1].trim();
            todaySchedule.push(scheduleObj);
        } catch (error) {
        }
    }

    var list = document.querySelector('post-list');
    list.posts = todaySchedule;
    list.onTeacherTap = function(e) {
      name = e.model.item.teacher.replace(" ", "_");
      console.log(e.model.item);
      requestAdditionalData(name, "teacher", renderTeacher);
    }
    list.onRoomTap = function(e) {
      name = e.model.item.room.replace("-", "_")
      requestAdditionalData(name, "room", renderRoom);
    }
  }

  function cleanString(text) {
    text = text.toLowerCase();
    text = text.replace(/ /g, "_"); //Remove spaces
    text = text.replace(/-/g, ""); //Remove dashes
    text = text.replace(/\./g, ""); //Remove periods
    return text;
  }

  document.addEventListener('WebComponentsReady', function() {
    var date = new Date();
    renderSchedule(date, false);
  });

  </script>

  <style>
  html,body {
    height: 100%;
    margin: 0;
    #background-color: #e6eef4;
    font-family: 'RobotoDraft', sans-serif;
  }
  #drawerheader {
    background: white;
  }
  #toastButton {
      display: none;
      color: #2196f3;
  }
  .image-container {
    text-align: center;
  }
  paper-button {
    width: 100%;
    text-align: left;
    text-transform: none;
    font-size: 14px;
  }
  #changepassword {
    color:white;
    background:#2196f3;
  }
  .drawer-icon {
    padding-right: 16px;
  }
  google-map {
    height: 600px;
  }
  #mainheader {
    height: 100%;
    background: #efefef;
    overflow: auto;
    -webkit-overflow-scrolling: touch;
  }
  paper-toolbar {
    background: #0d47a1;
    color: white;
  }
  .container {
    width: 80%;
    margin: 24px auto;
    #background:blue;
  }
  .fullsizeimage {
    margin: 16px;
  }
  @media (min-width: 720px) {
    .container {
      width: 540px;
    }
  }
  #dialog {
    width: 100%;
    height: 100%;
  }
  </style>
</head>

<body unresolved="">
  <paper-toast id="toast" text="" duration=10000>
  </paper-toast>
  <paper-drawer-panel id="drawerpanel" force-narrow>
    <paper-header-panel id="drawerheader" drawer>
      <paper-toolbar>
        <span class="title">EPSchedule</span>
      </paper-toolbar>
      <div>
        <div class="image-container">
          <img src="images/epslogo.jpg">
        </div>
        <paper-button noink onclick="signOut()">
          <iron-icon class="drawer-icon" icon="account-circle"></iron-icon>Sign out
        </paper-button>
        <paper-button noink onclick="openSettings()">
          <iron-icon class="drawer-icon" icon="settings"></iron-icon>Settings
        </paper-button>
        <paper-button noink onclick="reportBug()">
          <iron-icon class="drawer-icon" icon="bug-report"></iron-icon>Report a bug
        </paper-button>
        <paper-button noink onclick="about()">
          <iron-icon class="drawer-icon" icon="info"></iron-icon>About
        </paper-button>
      </div>
    </paper-header-panel>
    <paper-header-panel id="mainheader" main>
      <paper-toolbar>
        <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
        <span class="title" id="day">Today</span>
        <paper-icon-button icon="arrow-back" onclick="dateBack()"></paper-icon-button>
        <paper-icon-button icon="arrow-forward" onclick="dateForward()"></paper-icon-button>
        <!-- example of showing avatar in toolbar. could also go in drawer -->
        <paper-icon-button src="96x96_photos/steve_fassino.jpg" onclick="renderClass('geometry')"></paper-icon-button>
      </paper-toolbar>
      <div id="container" class="container" layout="" vertical="" center="">
        <post-list show="all"></post-list>
      </div>
    </paper-header-panel>
  </paper-drawer-panel>
  <paper-dialog id="dialog">
  </paper-dialog>


</body></html>
